<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AdayIQ Pro • Mini ATS</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PDF.js (PDF text extraction) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js" crossorigin="anonymous"></script>
  <!-- Mammoth (DOCX text extraction) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#070A14;
      --bg2:#0B1022;
      --line:rgba(255,255,255,.08);
      --muted:rgba(255,255,255,.65);
      --text:rgba(255,255,255,.92);
      --accent:#3DDCFF;
      --accent2:#6C5CE7;
      --good:#2ECC71;
      --bad:#FF4D6D;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:26px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(61,220,255,.14), transparent 55%),
        radial-gradient(900px 520px at 85% 8%, rgba(108,92,231,.16), transparent 58%),
        radial-gradient(900px 520px at 40% 110%, rgba(61,220,255,.10), transparent 58%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      color:var(--text);
      overflow-x:hidden;
    }
    .wrap{max-width:1220px;margin:28px auto;padding:0 18px 60px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:16px 16px;border:1px solid var(--line);border-radius:24px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position:sticky;top:12px;z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:240px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(61,220,255,.9), rgba(108,92,231,.75));
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      font-weight:800;letter-spacing:.5px;
    }
    .brand h1{font-size:18px;margin:0;line-height:1.15}
    .brand p{margin:2px 0 0 0;font-size:12px;color:var(--muted)}
    .chips{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:12px;color:var(--muted);
    }
    .chip b{color:var(--text);font-weight:600}
    .btn{
      cursor:pointer;border:none;
      padding:10px 14px;border-radius:14px;
      background: rgba(255,255,255,.05);
      color:var(--text);font-weight:600;
      border:1px solid rgba(255,255,255,.10);
      transition:.18s transform, .18s background;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px);background: rgba(255,255,255,.07)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(61,220,255,.28), rgba(108,92,231,.26));
      border:1px solid rgba(61,220,255,.35);
    }
    .btn.danger{
      background: rgba(255,77,109,.09);
      border:1px solid rgba(255,77,109,.25);
      color:#ffd3db;
    }
    .grid{display:grid;grid-template-columns: 1.08fr .92fr;gap:18px;margin-top:18px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .brand{min-width:auto}}
    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:16px 18px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel .hd h2{margin:0;font-size:15px}
    .panel .hd .sub{font-size:12px;color:var(--muted)}
    .panel .bd{padding:16px 18px}
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:12px 16px;border-top:1px solid rgba(255,255,255,.06);
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.16);
    }
    .tab{
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-weight:700;font-size:13px;color:var(--muted);
      cursor:pointer;
    }
    .tab.active{color:var(--text);border-color:rgba(61,220,255,.35);background: rgba(61,220,255,.08)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 760px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input[type="text"], input[type="url"], textarea, select{
      width:100%;padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,20,.55);
      color: var(--text);
      outline:none;
    }
    textarea{min-height:110px;resize:vertical;line-height:1.45}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .divider{height:1px;background: var(--line);margin:14px 0}
    .fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .fileLabel{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      cursor:pointer;font-weight:700;font-size:13px;
    }
    .fileLabel input{display:none}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--muted);font-size:12px;
    }
    .pill .dot{width:8px;height:8px;border-radius:99px;background: var(--accent)}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{
      border:1px solid rgba(255,255,255,.09);
      background: rgba(0,0,0,.16);
      border-radius: 18px;
      padding:12px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .item .left{display:flex;flex-direction:column;gap:6px}
    .item .title{font-weight:800;letter-spacing:.2px}
    .item .meta{font-size:12px;color:var(--muted)}
    .badge{
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      font-size:12px;font-weight:800;
      display:inline-flex;align-items:center;gap:8px;
      white-space:nowrap;
    }
    .badge.good{border-color: rgba(46,204,113,.35); background: rgba(46,204,113,.10); color:#d7ffe9;}
    .badge.bad{border-color: rgba(255,77,109,.35); background: rgba(255,77,109,.10); color:#ffd3db;}
    .score{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid rgba(61,220,255,.25);
      background: rgba(61,220,255,.08);
      font-weight:900;
    }
    .searchRow{display:flex;gap:10px;align-items:center}
    .searchRow input{flex:1}
    table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:10px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    td{
      padding:12px 10px;
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      vertical-align:top;
      font-size:13px;
    }
    td:first-child{border-left:1px solid rgba(255,255,255,.08);border-top-left-radius:14px;border-bottom-left-radius:14px}
    td:last-child{border-right:1px solid rgba(255,255,255,.08);border-top-right-radius:14px;border-bottom-right-radius:14px}
    .x{display:inline-block;width:10px;height:10px;border-radius:999px;background: var(--bad)}
    .v{display:inline-block;width:10px;height:10px;border-radius:999px;background: var(--good)}
    .mini{font-size:12px;color:var(--muted)}
    .toast{
      position:fixed;right:18px;bottom:18px;
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.12);
      padding:12px 14px;border-radius:16px;
      box-shadow: var(--shadow);
      max-width:min(520px, calc(100vw - 36px));
      display:none;
      z-index:50;
    }
    .toast.show{display:block}
    .toast b{display:block;margin-bottom:4px}
    .progress{
      height:10px;border-radius:999px;overflow:hidden;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
    }
    .progress > div{height:100%;width:0;background: linear-gradient(90deg, rgba(61,220,255,.9), rgba(108,92,231,.85));}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; padding:3px 8px; border:1px solid rgba(255,255,255,.16); border-bottom-color:rgba(255,255,255,.08); border-radius:10px; background: rgba(255,255,255,.04); color: var(--muted);}
    .footerNote{margin-top:14px;color:var(--muted);font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">AI</div>
        <div>
          <h1>AdayIQ Pro</h1>
          <p>Mini ATS • Kanıtlı Ön Eleme • Aday Havuzu • Karşılaştır • TR/EN</p>
        </div>
      </div>

      <div class="chips">
        <div class="chip">Tarama: <b>Kural Tabanlı</b></div>
        <div class="chip">Güven: <b>Kanıt Zorunlu</b></div>
        <button class="btn" id="btnHelp">Nasıl Kullanılır</button>
        <button class="btn primary" id="btnExport">Excel'e Aktar (CSV)</button>
      </div>
    </div>

    <div class="panel" style="margin-top:16px">
      <div class="hd">
        <div>
          <h2>Hızlı Başlangıç</h2>
          <div class="sub">1) Pozisyonu tanımla → 2) CV/LinkedIn ekle → 3) “Eşleştir & Sırala” ile skor + kanıt gör → 4) Kısa liste + karşılaştır → 5) CSV indir</div>
        </div>
        <div class="pill"><span class="dot"></span> Tamamen local (tarayıcı içinde). Veri dışarı çıkmaz.</div>
      </div>

      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="tab-jobs">Pozisyonlar</div>
        <div class="tab" data-tab="tab-candidates">Adaylar</div>
        <div class="tab" data-tab="tab-match">Eşleştir & Sırala</div>
        <div class="tab" data-tab="tab-compare">Karşılaştır</div>
        <div class="tab" data-tab="tab-audit">Denetim Kaydı</div>
      </div>

      <div class="bd">
        <!-- JOBS -->
        <section id="tab-jobs">
          <div class="row">
            <div>
              <label>Pozisyon Başlığı</label>
              <input type="text" id="jobTitle" placeholder="Örn: Kıdemli İş Analisti / Product Owner" />
            </div>
            <div>
              <label>Arama Dili</label>
              <select id="langMode">
                <option value="tr" selected>Türkçe (TR)</option>
                <option value="en">English (EN)</option>
                <option value="mix">TR + EN (Karışık)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Must Kriterleri (Her satıra 1)</label>
              <textarea id="mustList" placeholder="Örn:
business analysis
user story
acceptance criteria
bpmn
api"></textarea>
              <div class="hint">TR/EN eş anlamlı eşleştirme açık (ör. “business analysis” ⇄ “iş analizi”).</div>
            </div>
            <div>
              <label>Nice-to-have (Her satıra 1)</label>
              <textarea id="niceList" placeholder="Örn:
uml
jira
confluence
fintech
sql"></textarea>
              <div class="hint">Nice kriterler skoru artırır ama “Uygun” kararını tek başına değiştirmez.</div>
            </div>
          </div>

          <div class="divider"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <button class="btn primary" id="btnSaveJob">Pozisyonu Kaydet</button>
            <button class="btn" id="btnLoadDemo">Demo Pozisyon Yükle</button>
            <span class="mini">Kısayol: <span class="kbd">Ctrl</span> + <span class="kbd">S</span></span>
          </div>
          <div class="footerNote">İpucu: MUST listeni çok katı tutarsan “analist” CV’leri bile elenebilir. Bu yüzden eş anlamlı + kanıtlı tarama kullanıyoruz.</div>
        </section>

        <!-- CANDIDATES -->
        <section id="tab-candidates" style="display:none">
          <div class="grid">
            <div class="panel" style="box-shadow:none">
              <div class="hd">
                <div>
                  <h2>Aday Ekle</h2>
                  <div class="sub">LinkedIn URL’den ad-soyad otomatik tahmin edilir. Dosya yükleyince metin çıkarılır.</div>
                </div>
                <div class="pill"><span class="dot"></span> OCR yok (görsel PDF desteklenmez)</div>
              </div>
              <div class="bd">
                <label>Ad Soyad</label>
                <input type="text" id="candName" placeholder="Aday adı soyadı" />

                <div class="row">
                  <div>
                    <label>Kaynak (LinkedIn / Referans / Site)</label>
                    <input type="url" id="candSource" placeholder="Örn: https://www.linkedin.com/in/serdar-torun/" />
                    <div class="hint">URL girip alan dışına tıklayınca ad-soyad otomatik doldurulur.</div>
                  </div>
                  <div>
                    <label>Etiketler (virgülle)</label>
                    <input type="text" id="candTags" placeholder="Örn: Senior, Remote, FinTech" />
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label>CV Dosyası Yükle (PDF/DOCX/TXT)</label>
                    <div class="fileRow">
                      <label class="fileLabel">
                        Dosya Seç
                        <input type="file" id="cvFile" accept=".pdf,.docx,.txt,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain" />
                      </label>
                      <span class="pill" id="cvFileInfo"><span class="dot"></span> Dosya seçilmedi</span>
                    </div>
                    <div class="hint">Dosya seçildikten sonra metin çıkarılır ve “CV Metni” alanına yazılır.</div>
                  </div>

                  <div>
                    <label>LinkedIn / Ek Doküman (opsiyonel)</label>
                    <div class="fileRow">
                      <label class="fileLabel">
                        Dosya Seç
                        <input type="file" id="lnFile" accept=".pdf,.docx,.txt,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain" />
                      </label>
                      <span class="pill" id="lnFileInfo"><span class="dot"></span> Dosya seçilmedi</span>
                    </div>
                    <div class="hint">LinkedIn URL’den otomatik çekme yok; metin/doküman ile çalışır.</div>
                  </div>
                </div>

                <label>CV Metni</label>
                <textarea id="cvText" placeholder="CV metnini buraya yapıştırabilir veya dosya yükleyebilirsin..."></textarea>

                <label>LinkedIn Metni (opsiyonel)</label>
                <textarea id="lnText" placeholder="LinkedIn profil metnini buraya yapıştırabilirsin..."></textarea>

                <div class="divider"></div>

                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                  <button class="btn primary" id="btnAddCandidate">Adayı Kaydet</button>
                  <button class="btn" id="btnClearForm">Formu Temizle</button>
                </div>

                <div style="margin-top:12px">
                  <div class="progress"><div id="progBar"></div></div>
                  <div class="hint" id="progText" style="margin-top:8px">Hazır.</div>
                </div>
              </div>
            </div>

            <div class="panel" style="box-shadow:none">
              <div class="hd">
                <div>
                  <h2>Adaylar</h2>
                  <div class="sub">Seçili adayı düzenle / sil / export</div>
                </div>
                <button class="btn danger" id="btnDeleteCandidate" disabled>Sil</button>
              </div>
              <div class="bd">
                <div class="searchRow">
                  <input type="text" id="candSearch" placeholder="Aday ara (ad, etiket, kaynak)" />
                  <button class="btn" id="btnFilterAll">Tümü</button>
                </div>
                <div class="list" id="candList"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- MATCH -->
        <section id="tab-match" style="display:none">
          <div class="grid">
            <div class="panel" style="box-shadow:none">
              <div class="hd">
                <div>
                  <h2>Sıralamada Ara</h2>
                  <div class="sub">MUST kriterler + kanıt ile otomatik puanlama</div>
                </div>
                <button class="btn" id="btnRunMatch">Eşleştir & Sırala</button>
              </div>
              <div class="bd">
                <div class="row">
                  <div>
                    <label>Arama</label>
                    <input type="text" id="rankSearch" placeholder="Sıralamada ara (aday adı/etiket)" />
                  </div>
                  <div>
                    <label>Filtre</label>
                    <select id="rankFilter">
                      <option value="all" selected>Tümü</option>
                      <option value="fit">Uygun</option>
                      <option value="nofit">Uygun Değil</option>
                    </select>
                  </div>
                </div>
                <div class="list" id="rankList" style="margin-top:14px"></div>
              </div>
            </div>

            <div class="panel" style="box-shadow:none">
              <div class="hd">
                <div>
                  <h2>Skor Kartı Kanıtları</h2>
                  <div class="sub" id="scoreSub">Bir aday seç.</div>
                </div>
                <div class="pill"><span class="dot"></span> Kanıt gösterimi açık</div>
              </div>
              <div class="bd">
                <table>
                  <thead>
                    <tr>
                      <th style="width:24%">Kriter</th>
                      <th style="width:10%">Durum</th>
                      <th>Kanıt</th>
                    </tr>
                  </thead>
                  <tbody id="scoreTable"></tbody>
                </table>
                <div class="footerNote">
                  Not: Uygun çıkmıyorsa genelde (1) CV metni boş gelmiştir (PDF görsel olabilir) veya (2) kriter TR/EN uyumsuzdur. Bu sürümde TR/EN eş anlamlılar eklendi.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- COMPARE -->
        <section id="tab-compare" style="display:none">
          <div class="panel" style="box-shadow:none">
            <div class="hd">
              <div>
                <h2>Karşılaştır</h2>
                <div class="sub">Aynı pozisyon için 2 adayı yan yana kıyasla</div>
              </div>
              <button class="btn" id="btnCompare">Karşılaştır</button>
            </div>
            <div class="bd">
              <div class="row">
                <div>
                  <label>Aday 1</label>
                  <select id="cmp1"></select>
                </div>
                <div>
                  <label>Aday 2</label>
                  <select id="cmp2"></select>
                </div>
              </div>
              <div class="divider"></div>
              <div id="cmpOut" class="mini">Karşılaştırma için 2 aday seç.</div>
            </div>
          </div>
        </section>

        <!-- AUDIT -->
        <section id="tab-audit" style="display:none">
          <div class="panel" style="box-shadow:none">
            <div class="hd">
              <div>
                <h2>Denetim Kaydı</h2>
                <div class="sub">Son işlemler / hatalar</div>
              </div>
              <button class="btn" id="btnClearAudit">Temizle</button>
            </div>
            <div class="bd">
              <textarea id="auditLog" readonly style="min-height:260px"></textarea>
              <div class="footerNote">Not: GitHub Pages’te çalışır. Veriler sadece tarayıcında (localStorage).</div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><b id="toastTitle">Bilgi</b><div id="toastMsg"></div></div>

  <script>
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const now = () => new Date().toISOString().replace('T',' ').slice(0,19);

    function toast(title, msg){
      $("#toastTitle").textContent = title;
      $("#toastMsg").textContent = msg;
      const t = $("#toast");
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 3600);
    }
    function logAudit(msg){
      const area = $("#auditLog");
      area.value = `[${now()}] ${msg}\n` + area.value;
    }
    function normalizeText(s){
      if(!s) return "";
      return s.toLowerCase()
        .replaceAll("ı","i").replaceAll("İ","i")
        .replaceAll("ş","s").replaceAll("Ş","s")
        .replaceAll("ğ","g").replaceAll("Ğ","g")
        .replaceAll("ü","u").replaceAll("Ü","u")
        .replaceAll("ö","o").replaceAll("Ö","o")
        .replaceAll("ç","c").replaceAll("Ç","c")
        .replace(/[\u200B-\u200D\uFEFF]/g, "")
        .replace(/\s+/g," ").trim();
    }
    function linesToList(txt){
      return (txt || "").split(/\r?\n/g).map(s=>s.trim()).filter(Boolean);
    }
    function nameFromLinkedInUrl(url){
      try{
        const u = new URL(url);
        const m = u.pathname.match(/\/in\/([^\/?#]+)/i);
        if(!m) return "";
        const slug = m[1].replace(/[-_]+/g," ").replace(/\d+/g," ").replace(/\s+/g," ").trim();
        if(!slug) return "";
        return slug.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
      }catch{ return ""; }
    }
    function nameFromFileName(fileName){
      const clean = (fileName||"").replace(/\.[^.]+$/,"").replace(/[_\-]+/g," ").replace(/\d+/g," ").replace(/\s+/g," ").trim();
      if(!clean) return "";
      return clean.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(" ");
    }
    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    // Storage
    const STORE_KEY = "adayiq_pro_v1";
    const state = { job:{title:"",lang:"tr",must:[],nice:[]}, candidates:[], selectedCandidateId:null, lastRank:[] };

    function saveState(){
      localStorage.setItem(STORE_KEY, JSON.stringify({job:state.job,candidates:state.candidates}));
      logAudit("Durum kaydedildi (localStorage).");
    }
    function loadState(){
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return;
      try{
        const snap = JSON.parse(raw);
        if(snap.job) state.job = snap.job;
        if(Array.isArray(snap.candidates)) state.candidates = snap.candidates;
        logAudit("Durum yüklendi (localStorage).");
      }catch(e){ logAudit("State yükleme hatası: "+e); }
    }

    // Synonyms (TR/EN)
    const synonyms = {
      "business analysis": ["business analysis","iş analizi","is analizi","iş analisti","is analisti","kıdemli iş analisti","kidemli is analisti","ba"],
      "user story": ["user story","user stories","kullanıcı hikayesi","kullanici hikayesi","kullanıcı hikayeleri","userstory"],
      "acceptance criteria": ["acceptance criteria","acceptance criterion","kabul kriteri","kabul kriterleri","ac","acceptance"],
      "bpmn": ["bpmn","business process model and notation","iş süreci modelleme","is sureci modelleme","bpmn diyagram"],
      "api": ["api","rest api","restful","soap","graphql","endpoint","servis","web servis","web service"],
      "uml": ["uml","use case","sequence diagram","activity diagram","class diagram","kullanim senaryosu","kullanım senaryosu"],
      "jira": ["jira","atlassian jira"],
      "confluence": ["confluence","atlassian confluence"],
      "sql": ["sql","postgres","oracle","mysql","mssql","sql server"],
      "fintech": ["fintech","sermaye piyasasi","sermaye piyasası","yatirim","yatırım","brokerage","trading","otc","forex","spot fx"]
    };

    function expandCriterion(crit){
      const k = normalizeText(crit);
      if(synonyms[k]) return synonyms[k];
      for(const key of Object.keys(synonyms)){ if(normalizeText(key)===k) return synonyms[key]; }
      const out = new Set([crit,k]);
      if(k.includes(" ")) out.add(k.replaceAll(" ",""));
      return Array.from(out).filter(Boolean);
    }

    function findEvidence(hayRaw, critRaw){
      const hay = normalizeText(hayRaw);
      if(!hay) return {found:false,snippet:""};
      const variants = expandCriterion(critRaw).map(normalizeText).filter(Boolean);

      let idx = -1, hit = "";
      for(const v of variants){ idx = hay.indexOf(v); if(idx!==-1){ hit=v; break; } }

      if(idx===-1){
        for(const v of variants){
          const toks = v.split(" ").filter(t => t.length>=3);
          if(toks.length>=2 && toks.every(t => hay.includes(t))){
            idx = hay.indexOf(toks[0]); hit = toks.join(" "); break;
          }
        }
      }
      if(idx===-1) return {found:false,snippet:""};
      const start = Math.max(0, idx-80), end = Math.min(hay.length, idx+hit.length+140);
      const snippet = (start>0?"… ":"") + hay.slice(start,end).trim() + (end<hay.length?" …":"");
      return {found:true,snippet};
    }

    function scoreCandidate(candidate, job){
      const combined = (candidate.cvText||"") + "\n" + (candidate.lnText||"");
      const must = job.must||[], nice = job.nice||[];
      const mustResults = must.map(c => ({c,...findEvidence(combined,c),kind:"must"}));
      const niceResults = nice.map(c => ({c,...findEvidence(combined,c),kind:"nice"}));
      const mustFound = mustResults.filter(r=>r.found).length;
      const niceFound = niceResults.filter(r=>r.found).length;
      const mustTotal = must.length||1, niceTotal = nice.length||0;
      const mustScore = Math.round((mustFound/mustTotal)*80);
      const niceScore = niceTotal ? Math.round((niceFound/niceTotal)*20) : 0;
      const total = Math.min(100, mustScore+niceScore);
      const fit = must.length ? (mustFound===must.length) : true;
      return {total,fit,mustResults,niceResults,mustFound,mustTotal,niceFound,niceTotal};
    }

    function downloadCSV(rows, fileName){
      const esc = (v) => {
        const s = (v ?? "").toString();
        if(/[,"\n;]/.test(s)) return `"${s.replaceAll('"','""')}"`;
        return s;
      };
      const csv = rows.map(r => r.map(esc).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
    }

    // Tabs
    function setTab(tabId){
      $$(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab===tabId));
      ["tab-jobs","tab-candidates","tab-match","tab-compare","tab-audit"].forEach(id => $("#"+id).style.display = (id===tabId)?"":"none");
      if(tabId==="tab-candidates") renderCandidateList();
      if(tabId==="tab-compare") renderCompareSelects();
    }
    $$(".tab").forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

    // Candidate list
    function renderCandidateList(){
      const q = normalizeText($("#candSearch").value);
      const list = $("#candList"); list.innerHTML = "";
      const filtered = state.candidates.filter(c => {
        if(!q) return true;
        return normalizeText(c.name).includes(q) || normalizeText(c.tags).includes(q) || normalizeText(c.source).includes(q);
      });
      if(!filtered.length){
        list.innerHTML = `<div class="hint">Henüz aday yok. Soldan “Aday Ekle”.</div>`;
        $("#btnDeleteCandidate").disabled = true;
        return;
      }
      filtered.sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||"")).forEach(c => {
        const div = document.createElement("div");
        div.className = "item"; div.style.cursor="pointer";
        div.innerHTML = `
          <div class="left">
            <div class="title">${escapeHtml(c.name||"İsimsiz Aday")}</div>
            <div class="meta">source: ${escapeHtml(c.source||"-")} • tags: ${escapeHtml(c.tags||"-")}</div>
            <div class="meta">CV chars: ${(c.cvText||"").length} • LN chars: ${(c.lnText||"").length}</div>
          </div>
          <div class="badge">${state.selectedCandidateId===c.id ? "Seçili" : "Seç"}</div>
        `;
        div.onclick = () => selectCandidate(c.id);
        list.appendChild(div);
      });
    }

    function selectCandidate(id){
      const c = state.candidates.find(x => x.id===id);
      state.selectedCandidateId = id;
      $("#btnDeleteCandidate").disabled = !c;
      if(!c) return;
      $("#candName").value = c.name||"";
      $("#candSource").value = c.source||"";
      $("#candTags").value = c.tags||"";
      $("#cvText").value = c.cvText||"";
      $("#lnText").value = c.lnText||"";
      $("#cvFileInfo").innerHTML = `<span class="dot"></span> Dosya: ${escapeHtml(c.cvFileName||"—")}`;
      $("#lnFileInfo").innerHTML = `<span class="dot"></span> Dosya: ${escapeHtml(c.lnFileName||"—")}`;
      renderCandidateList();
      renderCompareSelects();
      toast("Aday seçildi", c.name||"İsimsiz Aday");
      logAudit("Aday seçildi: "+(c.name||"İsimsiz"));
    }

    // Ranking
    function renderRank(){
      const q = normalizeText($("#rankSearch").value);
      const f = $("#rankFilter").value;
      const list = $("#rankList"); list.innerHTML = "";
      const job = state.job;
      if(!job.must?.length && !job.nice?.length){ list.innerHTML = `<div class="hint">Önce “Pozisyonlar” sekmesinden kriterleri kaydet.</div>`; return; }
      if(!state.candidates.length){ list.innerHTML = `<div class="hint">Önce “Adaylar” sekmesinden aday ekle.</div>`; return; }

      const ranked = state.candidates.map(c => ({c, s: scoreCandidate(c, job)})).sort((a,b)=>b.s.total-a.s.total);
      state.lastRank = ranked;

      const filtered = ranked.filter(r=>{
        const hay = normalizeText((r.c.name||"")+" "+(r.c.tags||""));
        if(q && !hay.includes(q)) return false;
        if(f==="fit" && !r.s.fit) return false;
        if(f==="nofit" && r.s.fit) return false;
        return true;
      });

      filtered.forEach((r,i)=>{
        const div = document.createElement("div");
        div.className="item"; div.style.cursor="pointer";
        div.innerHTML = `
          <div class="left">
            <div class="title">#${i+1} ${escapeHtml(r.c.name||"İsimsiz Aday")}</div>
            <div class="meta">${escapeHtml(r.c.tags||"")}</div>
            <div class="meta">MUST: ${r.s.mustFound}/${r.s.mustTotal} • NICE: ${r.s.niceFound}/${r.s.niceTotal||0}</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="score">${r.s.total}</div>
            <div class="badge ${r.s.fit?"good":"bad"}">${r.s.fit?"Uygun":"Uygun Değil"}</div>
          </div>
        `;
        div.onclick = () => showScoreCard(r.c.id);
        list.appendChild(div);
      });
      if(!filtered.length) list.innerHTML = `<div class="hint">Filtreye göre sonuç yok.</div>`;
    }

    function showScoreCard(candidateId){
      const r = state.lastRank.find(x => x.c.id===candidateId);
      if(!r) return;
      const c = r.c, s = r.s;
      $("#scoreSub").textContent = `${c.name||"İsimsiz Aday"} • Skor: ${s.total} • MUST: ${s.mustFound}/${s.mustTotal}`;
      const tb = $("#scoreTable"); tb.innerHTML = "";
      const addRow = (crit, found, snippet) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="pill"><span class="dot"></span> ${escapeHtml(crit)}</span></td>
          <td>${found ? '<span class="v"></span>' : '<span class="x"></span>'}</td>
          <td>${found ? `<div>${escapeHtml(snippet||"")}</div>` : `<div class="mini">Metinde bulunamadı.</div>`}</td>
        `;
        tb.appendChild(tr);
      };
      s.mustResults.forEach(rw=>addRow(rw.c,rw.found,rw.snippet));
      s.niceResults.forEach(rw=>addRow(rw.c,rw.found,rw.snippet));
      logAudit(`Skor kartı: ${c.name||"İsimsiz"} skor=${s.total}`);
    }

    // Compare
    function renderCompareSelects(){
      const arr = state.candidates.slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""));
      const mk = (sel) => { sel.innerHTML = `<option value="">Seç…</option>` + arr.map(c=>`<option value="${c.id}">${escapeHtml(c.name||"İsimsiz Aday")}</option>`).join(""); };
      mk($("#cmp1")); mk($("#cmp2"));
    }
    function runCompare(){
      const id1=$("#cmp1").value, id2=$("#cmp2").value;
      if(!id1||!id2||id1===id2){ $("#cmpOut").textContent="Karşılaştırma için 2 farklı aday seç."; return; }
      const c1=state.candidates.find(x=>x.id===id1), c2=state.candidates.find(x=>x.id===id2);
      const s1=scoreCandidate(c1,state.job), s2=scoreCandidate(c2,state.job);
      $("#cmpOut").innerHTML = `
        <div class="item"><div class="left"><div class="title">${escapeHtml(c1.name||"Aday 1")} (${s1.total})</div><div class="meta">MUST ${s1.mustFound}/${s1.mustTotal} • NICE ${s1.niceFound}/${s1.niceTotal||0}</div></div>
        <div class="left" style="text-align:right"><div class="title">${escapeHtml(c2.name||"Aday 2")} (${s2.total})</div><div class="meta">MUST ${s2.mustFound}/${s2.mustTotal} • NICE ${s2.niceFound}/${s2.niceTotal||0}</div></div></div>
        <div class="hint">Detaylı kanıt için “Eşleştir & Sırala” sekmesini kullan.</div>
      `;
      logAudit(`Karşılaştırma: ${c1.name} vs ${c2.name}`);
    }

    // Progress
    function setProgress(pct,text){
      $("#progBar").style.width = `${Math.max(0,Math.min(100,pct))}%`;
      $("#progText").textContent = text || "Hazır.";
    }

    // PDF.js config
    if(window.pdfjsLib){
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js";
    }

    async function extractTextFromPDF(arrayBuffer){
      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;
      let full = "";
      for(let i=1;i<=pdf.numPages;i++){
        setProgress(Math.round((i-1)/pdf.numPages*100), `PDF okunuyor… Sayfa ${i}/${pdf.numPages}`);
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        full += content.items.map(it=>it.str).join(" ") + "\n";
        await sleep(0);
      }
      setProgress(100,"PDF okuma tamamlandı.");
      return full;
    }
    async function extractTextFromDOCX(arrayBuffer){
      setProgress(20,"DOCX okunuyor…");
      const res = await mammoth.extractRawText({arrayBuffer});
      setProgress(100,"DOCX okuma tamamlandı.");
      return res.value || "";
    }
    async function extractTextFromTXT(file){
      setProgress(20,"TXT okunuyor…");
      const text = await file.text();
      setProgress(100,"TXT okuma tamamlandı.");
      return text || "";
    }

    async function handleFileInto(targetTextArea, fileInfoEl, file){
      if(!file) return;
      fileInfoEl.innerHTML = `<span class="dot"></span> Dosya: ${escapeHtml(file.name)} (${Math.round(file.size/1024)} KB)`;
      await sleep(0); // file picker freeze fix
      try{
        setProgress(5,"Dosya hazırlanıyor…");
        const ext=(file.name.split(".").pop()||"").toLowerCase();
        let text="";
        if(ext==="pdf" || file.type==="application/pdf"){
          text = await extractTextFromPDF(await file.arrayBuffer());
        }else if(ext==="docx" || (file.type||"").includes("officedocument")){
          text = await extractTextFromDOCX(await file.arrayBuffer());
        }else{
          text = await extractTextFromTXT(file);
        }
        targetTextArea.value = text.trim();
        if(!$("#candName").value.trim()){
          const guess = nameFromFileName(file.name);
          if(guess) $("#candName").value = guess;
        }
        toast("Metin çıkarıldı","Dosya içeriği okundu.");
        logAudit(`Dosya okundu: ${file.name} chars=${text.length}`);
      }catch(e){
        setProgress(0,"Hata oluştu.");
        toast("Okuma Hatası","PDF görsel olabilir veya dosya bozuk olabilir. Text PDF export deneyin.");
        logAudit("Dosya okuma hatası: "+e);
        console.error(e);
      }
      setProgress(0,"Hazır.");
    }

    // Events
    $("#btnHelp").addEventListener("click", ()=>toast("Nasıl Kullanılır","1) Pozisyon kriterlerini kaydet. 2) Aday ekle (CV yükle/metin yapıştır). 3) Eşleştir & Sırala’da skor+kanıt gör. 4) CSV indir."));
    $("#btnClearAudit").addEventListener("click", ()=>{ $("#auditLog").value=""; toast("Denetim","Kayıt temizlendi."); });

    $("#btnExport").addEventListener("click", ()=>{
      const job=state.job;
      const header=["Name","Source","Tags","Score","Fit","MustFound","MustTotal","NiceFound","NiceTotal"];
      const rows=[header];
      state.candidates.forEach(c=>{
        const s=(job.must?.length||job.nice?.length) ? scoreCandidate(c,job) : {total:"",fit:false,mustFound:"",mustTotal:"",niceFound:"",niceTotal:""};
        rows.push([c.name||"",c.source||"",c.tags||"",s.total,s.fit?"FIT":"NOFIT",s.mustFound,s.mustTotal,s.niceFound,s.niceTotal||0]);
      });
      downloadCSV(rows,"adayiq_export.csv");
      toast("İndirildi","CSV indirildi (Excel uyumlu).");
      logAudit("CSV export alındı.");
    });

    $("#btnSaveJob").addEventListener("click", ()=>{
      state.job.title=$("#jobTitle").value.trim();
      state.job.lang=$("#langMode").value;
      state.job.must=linesToList($("#mustList").value);
      state.job.nice=linesToList($("#niceList").value);
      saveState();
      toast("Pozisyon kaydedildi",`MUST: ${state.job.must.length} • NICE: ${state.job.nice.length}`);
    });
    $("#btnLoadDemo").addEventListener("click", ()=>{
      $("#jobTitle").value="Kıdemli İş Analisti / PO (FinTech)";
      $("#langMode").value="mix";
      $("#mustList").value=["business analysis","user story","acceptance criteria","bpmn","api"].join("\n");
      $("#niceList").value=["uml","jira","confluence","fintech","sql"].join("\n");
      toast("Demo yüklendi","Kaydetmeyi unutma.");
      logAudit("Demo pozisyon yüklendi.");
    });

    $("#candSource").addEventListener("blur", ()=>{
      const guess=nameFromLinkedInUrl($("#candSource").value);
      if(!$("#candName").value.trim() && guess){
        $("#candName").value=guess;
        toast("Ad tahmini","LinkedIn URL’den ad-soyad dolduruldu.");
        logAudit("LinkedIn URL’den ad tahmini: "+guess);
      }
    });

    $("#cvFile").addEventListener("change", async (e)=>{
      const file=e.target.files?.[0]; if(!file) return;
      await handleFileInto($("#cvText"), $("#cvFileInfo"), file);
      $("#cvFile").value="";
    });
    $("#lnFile").addEventListener("change", async (e)=>{
      const file=e.target.files?.[0]; if(!file) return;
      await handleFileInto($("#lnText"), $("#lnFileInfo"), file);
      $("#lnFile").value="";
    });

    $("#btnClearForm").addEventListener("click", ()=>{
      state.selectedCandidateId=null;
      $("#candName").value=""; $("#candSource").value=""; $("#candTags").value="";
      $("#cvText").value=""; $("#lnText").value="";
      $("#cvFileInfo").innerHTML=`<span class="dot"></span> Dosya seçilmedi`;
      $("#lnFileInfo").innerHTML=`<span class="dot"></span> Dosya seçilmedi`;
      $("#btnDeleteCandidate").disabled=true;
      renderCandidateList();
      toast("Form temizlendi","Yeni aday ekleyebilirsin.");
      logAudit("Aday formu temizlendi.");
    });

    $("#btnAddCandidate").addEventListener("click", ()=>{
      const name=$("#candName").value.trim();
      const source=$("#candSource").value.trim();
      const tags=$("#candTags").value.trim();
      const cvText=$("#cvText").value.trim();
      const lnText=$("#lnText").value.trim();
      if(!name && !source && !cvText && !lnText){ toast("Eksik bilgi","En azından ad veya CV metni ekle."); return; }

      const id = state.selectedCandidateId || crypto.randomUUID();
      const existing = state.candidates.find(x=>x.id===id);
      const payload = {
        id,
        name: name || nameFromLinkedInUrl(source) || "İsimsiz Aday",
        source,tags,cvText,lnText,
        cvFileName: ($("#cvFileInfo").textContent.includes("Dosya:") ? $("#cvFileInfo").textContent.replace("Dosya:","").trim() : ""),
        lnFileName: ($("#lnFileInfo").textContent.includes("Dosya:") ? $("#lnFileInfo").textContent.replace("Dosya:","").trim() : ""),
        createdAt: existing?.createdAt || new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      if(existing){ Object.assign(existing,payload); toast("Aday güncellendi",payload.name); logAudit("Aday güncellendi: "+payload.name); }
      else{ state.candidates.push(payload); toast("Aday eklendi",payload.name); logAudit("Aday eklendi: "+payload.name); }
      saveState();
      renderCandidateList();
      renderCompareSelects();
    });

    $("#btnDeleteCandidate").addEventListener("click", ()=>{
      const id=state.selectedCandidateId; if(!id) return;
      const c=state.candidates.find(x=>x.id===id);
      state.candidates = state.candidates.filter(x=>x.id!==id);
      state.selectedCandidateId=null;
      saveState();
      $("#btnClearForm").click();
      toast("Aday silindi", c?.name||"İsimsiz Aday");
      logAudit("Aday silindi: "+(c?.name||"İsimsiz"));
    });

    $("#candSearch").addEventListener("input", renderCandidateList);
    $("#btnFilterAll").addEventListener("click", ()=>{ $("#candSearch").value=""; renderCandidateList(); });

    $("#btnRunMatch").addEventListener("click", ()=>{
      if(!state.job.must?.length && !state.job.nice?.length){ toast("Pozisyon eksik","Önce kriterleri kaydet."); return; }
      renderRank(); toast("Sıralama hazır","Sağdan aday seçip kanıtları gör.");
    });
    $("#rankSearch").addEventListener("input", renderRank);
    $("#rankFilter").addEventListener("change", renderRank);

    $("#btnCompare").addEventListener("click", runCompare);

    // Init
    loadState();
    $("#jobTitle").value = state.job.title || "";
    $("#langMode").value = state.job.lang || "tr";
    $("#mustList").value = (state.job.must||[]).join("\n");
    $("#niceList").value = (state.job.nice||[]).join("\n");
    renderCandidateList();
    renderCompareSelects();
    logAudit("AdayIQ Pro başlatıldı.");
  </script>
</body>
</html>
